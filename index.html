<!doctype html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Î‘Î½Î±Ï†Î¿ÏÎ¬ + Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ (Synced Markers)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2f;
      --panel2:#0c1528;
      --text:#e7eefc;
      --muted:#9fb2d9;
      --accent:#6ea8ff;
      --accent2:#8bffa8;
      --danger:#ff5f6e;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --railW:56px;
      --topbarH:52px;
      --noteMaxW: 920px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% 10%, rgba(110,168,255,.22), transparent 45%),
                  radial-gradient(800px 500px at 85% 15%, rgba(139,255,168,.14), transparent 45%),
                  linear-gradient(180deg, #070c16 0%, #040814 100%);
      color:var(--text);
      overflow:hidden;
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding:12px;
    }

    .pane{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .topbar{
      height:var(--topbarH);
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(15,26,47,.92), rgba(12,21,40,.92));
      border-bottom:1px solid var(--line);
    }

    .title{
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 42vw;
    }

    .status{
      margin-left:auto;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 36vw;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:13px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(110,168,255,.18);
      border-color: rgba(110,168,255,.35);
    }
    .btn.primary:hover{ background: rgba(110,168,255,.24); }
    .btn.danger{
      background: rgba(255,95,110,.16);
      border-color: rgba(255,95,110,.35);
    }
    .btn.danger:hover{ background: rgba(255,95,110,.22); }

    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      user-select:none;
      cursor:pointer;
      font-weight:650;
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.25);
      border:1px solid var(--line);
    }
    .toggle.on{ color: var(--text); border-color: rgba(139,255,168,.35); background: rgba(139,255,168,.10); }
    .toggle.on .dot{ background: rgba(139,255,168,.75); border-color: rgba(139,255,168,.70); }

    /* Left pane (reference) */
    .refBody{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: var(--railW) 1fr;
    }

    .rail{
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(12,21,40,.95), rgba(10,18,32,.95));
      position:relative;
      overflow:hidden;
    }

    .railHint{
      position:absolute;
      top:10px; left:8px; right:8px;
      font-size:11px;
      color:rgba(231,238,252,.55);
      line-height:1.25;
    }

    .markerBtn{
      position:absolute;
      left:7px;
      width:42px;
      height:30px;
      border-radius: 999px;
      border:1px solid rgba(110,168,255,.40);
      background: rgba(110,168,255,.18);
      color: var(--text);
      font-weight:800;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .markerBtn:hover{
      background: rgba(110,168,255,.26);
      border-color: rgba(110,168,255,.55);
    }
    .markerBtn.active{
      background: rgba(139,255,168,.20);
      border-color: rgba(139,255,168,.55);
      transform: scale(1.04);
    }

    iframe{
      width:100%;
      height:100%;
      border:0;
      background:#fff;
    }

    /* Right pane (notes) */
    .notesShell{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      background: linear-gradient(180deg, rgba(12,21,40,.65), rgba(9,16,30,.65));
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
      align-items:center;
    }

    .tool{
      padding:7px 9px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:750;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tool:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }

    .tool.sep{
      width:1px; height:22px;
      padding:0; border:0; background: var(--line);
      cursor:default;
    }

    .notesList{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:14px;
    }

    .noteCard{
      max-width: var(--noteMaxW);
      margin: 0 auto 12px auto;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: 0 10px 26px rgba(0,0,0,.20);
      overflow:hidden;
    }

    .noteHead{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,26,47,.75), rgba(12,21,40,.75));
    }

    .badge{
      min-width:32px;
      height:26px;
      padding:0 10px;
      border-radius:999px;
      border:1px solid rgba(110,168,255,.35);
      background: rgba(110,168,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
    }

    .noteTitle{
      flex:1;
      min-width:0;
      font-weight:850;
      outline:none;
      border-radius:10px;
      padding:6px 8px;
      color: var(--text);
      background: rgba(255,255,255,.03);
      border:1px solid transparent;
    }
    .noteTitle:focus{ border-color: rgba(110,168,255,.35); background: rgba(110,168,255,.08); }

    .miniBtns{ display:flex; gap:8px; }
    .mini{
      padding:6px 8px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .mini:hover{ background: rgba(255,255,255,.10); color: var(--text); }

    .noteBody{
      padding: 12px 12px 14px 12px;
      background: rgba(0,0,0,.08);
    }

    .editor{
      min-height: 130px;
      outline:none;
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      line-height: 1.55;
    }

    .editor:focus{
      border-color: rgba(110,168,255,.35);
      box-shadow: 0 0 0 3px rgba(110,168,255,.12);
    }

    .editor img{
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      display:block;
      margin: 10px 0;
      border: 1px solid rgba(255,255,255,.10);
    }

    .emptyState{
      max-width: var(--noteMaxW);
      margin: 0 auto;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: var(--radius);
      padding: 18px;
      color: var(--muted);
      background: rgba(0,0,0,.12);
    }

    .pulse{
      animation: pulse 1.2s ease-out 1;
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(110,168,255,.0); }
      40%{ box-shadow: 0 0 0 6px rgba(110,168,255,.18); }
      100%{ box-shadow: 0 0 0 0 rgba(110,168,255,.0); }
    }

    @media (max-width: 1000px){
      body{ overflow:auto; }
      .app{ grid-template-columns: 1fr; height:auto; }
      .pane{ height: 80vh; }
      .title{ max-width: 70vw; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- LEFT: Reference -->
    <section class="pane" id="leftPane">
      <div class="topbar">
        <div class="title">Î‘Î½Î±Ï†Î¿ÏÎ¬</div>

        <button class="btn primary" id="btnAddMark" title="Î’Î¬Î¶ÎµÎ¹ ÏƒÎ·Î¼Î¬Î´Î¹ ÏƒÏ„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ ÏƒÎ·Î¼ÎµÎ¯Î¿ (scroll) Ï„Î·Ï‚ Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚">+ Î£Î·Î¼Î¬Î´Î¹</button>
        <div class="toggle" id="toggleSync" title="ÎÎ¿Î·Î¼Î±Ï„Î¹ÎºÏŒ sync: ÏƒÎºÏÎ¿Î»Î¬ÏÎµÎ¹Ï‚ Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬ â†’ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ ÎºÎ¿Î½Ï„Î¹Î½ÏŒ ÏƒÎ·Î¼Î¬Î´Î¹ & ÏƒÎµ Ï€Î¬ÎµÎ¹ ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® ÎµÎ½ÏŒÏ„Î·Ï„Î±">
          <span class="dot"></span> SYNC
        </div>

        <button class="btn" id="btnReloadRef" title="Reload Ï„Î·Î½ Î±Î½Î±Ï†Î¿ÏÎ¬">Reload</button>
        <button class="btn danger" id="btnClearAll" title="Î£Î²Î®Î½ÎµÎ¹ ÎŸÎ›Î‘ Ï„Î± ÏƒÎ·Î¼Î¬Î´Î¹Î± & ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ (Î¼ÏŒÎ½Î¿ ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ ref)">Reset</button>

        <div class="status" id="refStatus">Ï†ÏŒÏÏ„Ï‰ÏƒÎ·â€¦</div>
      </div>

      <div class="refBody">
        <div class="rail" id="rail">
          <div class="railHint">Î£Î·Î¼Î¬Î´Î¹Î±<br>Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬</div>
          <div id="railMarkers"></div>
        </div>

        <iframe id="refFrame" src="refs/yPhysicsALyceum1.html"></iframe>
      </div>
    </section>

    <!-- RIGHT: Notes -->
    <section class="pane" id="rightPane">
      <div class="topbar">
        <div class="title">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</div>

        <button class="btn" id="btnExport" title="Î•Î¾Î±Î³Ï‰Î³Î® ÏƒÎµ JSON (backup)">Export</button>
        <button class="btn" id="btnImport" title="Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î±Ï€ÏŒ JSON (restore)">Import</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />

        <div class="status" id="notesStatus">â€”</div>
      </div>

      <div class="notesShell">
        <div class="toolbar" id="toolbar">
          <div class="tool" data-cmd="bold"><b>B</b></div>
          <div class="tool" data-cmd="italic"><i>I</i></div>
          <div class="tool" data-cmd="underline"><u>U</u></div>
          <div class="tool sep"></div>
          <div class="tool" data-cmd="formatBlock" data-arg="H2">H2</div>
          <div class="tool" data-cmd="formatBlock" data-arg="H3">H3</div>
          <div class="tool" data-cmd="formatBlock" data-arg="BLOCKQUOTE">â</div>
          <div class="tool" data-cmd="formatBlock" data-arg="PRE">{"{}"}</div>
          <div class="tool sep"></div>
          <div class="tool" data-cmd="insertUnorderedList">â€¢ List</div>
          <div class="tool" data-cmd="insertOrderedList">1. List</div>
          <div class="tool sep"></div>
          <div class="tool" id="btnLink">Link</div>
          <div class="tool" id="btnImgUrl">Î•Î¹ÎºÏŒÎ½Î± URL</div>
          <div class="tool" id="btnImgUpload">Î•Î¹ÎºÏŒÎ½Î± Upload</div>
          <input type="file" id="imgFile" accept="image/*" style="display:none" />
        </div>

        <div class="notesList" id="notesList">
          <div class="emptyState" id="emptyState">
            Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î²Î¬Î»ÎµÎ¹ ÏƒÎ·Î¼Î¬Î´Î¹Î± Î±ÎºÏŒÎ¼Î±. Î Î®Î³Î±Î¹Î½Îµ Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬ ÏƒÏ„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï€Î¿Ï… Î¸ÎµÏ‚ ÎºÎ±Î¹ Ï€Î¬Ï„Î± <b>+ Î£Î·Î¼Î¬Î´Î¹</b>.<br>
            Tip: ÎšÎ¬Î¸Îµ ÏƒÎ·Î¼Î¬Î´Î¹ Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î· Î´Î¹ÎºÎ® Ï„Î¿Ï… â€œÏƒÎºÎ·Î½Î®â€ Î³Î¹Î± ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î´ÎµÎ¾Î¹Î¬.
          </div>
        </div>
      </div>
    </section>

  </div>

<script>
(() => {
  const REF_SRC = "refs/yPhysicsALyceum1.html";

  const els = {
    refFrame: document.getElementById("refFrame"),
    refStatus: document.getElementById("refStatus"),
    notesStatus: document.getElementById("notesStatus"),
    railMarkers: document.getElementById("railMarkers"),
    rail: document.getElementById("rail"),
    btnAddMark: document.getElementById("btnAddMark"),
    btnReloadRef: document.getElementById("btnReloadRef"),
    btnClearAll: document.getElementById("btnClearAll"),
    toggleSync: document.getElementById("toggleSync"),
    notesList: document.getElementById("notesList"),
    emptyState: document.getElementById("emptyState"),
    toolbar: document.getElementById("toolbar"),
    btnExport: document.getElementById("btnExport"),
    btnImport: document.getElementById("btnImport"),
    importFile: document.getElementById("importFile"),
    btnLink: document.getElementById("btnLink"),
    btnImgUrl: document.getElementById("btnImgUrl"),
    btnImgUpload: document.getElementById("btnImgUpload"),
    imgFile: document.getElementById("imgFile"),
  };

  // Force src (so Î´ÎµÎ½ â€œÏ‡Î¬Î½ÎµÏ„Î±Î¹â€ Î±Î½ ÎºÎ¬Ï„Î¹ Ï„Î¿ Î¬Î»Î»Î±Î¾Îµ)
  els.refFrame.src = REF_SRC;

  const storageKey = (name) => `${name}::${location.origin}${location.pathname}::${REF_SRC}`;

  function safeParse(json, fallback){
    try { return JSON.parse(json); } catch { return fallback; }
  }

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  // Data model
  let state = {
    syncOn: false,
    activeId: null,
    markers: [], // {id, title, y, createdAt}
    notes: {}    // id -> html
  };

  // Load / Save
  function load(){
    state.syncOn = safeParse(localStorage.getItem(storageKey("syncOn")), false) === true;
    state.markers = safeParse(localStorage.getItem(storageKey("markers")), []);
    state.notes   = safeParse(localStorage.getItem(storageKey("notes")), {});
    // sanitize
    if(!Array.isArray(state.markers)) state.markers = [];
    if(typeof state.notes !== "object" || !state.notes) state.notes = {};
    state.markers.sort((a,b)=> (a.y ?? 0) - (b.y ?? 0));
    applySyncUI();
    renderAll();
  }

  function save(){
    localStorage.setItem(storageKey("syncOn"), JSON.stringify(state.syncOn));
    localStorage.setItem(storageKey("markers"), JSON.stringify(state.markers));
    localStorage.setItem(storageKey("notes"), JSON.stringify(state.notes));
    updateStatuses();
  }

  function updateStatuses(extra=""){
    els.notesStatus.textContent = `${state.markers.length} ÏƒÎ·Î¼Î¬Î´Î¹Î± Â· autosave ON${extra ? " Â· " + extra : ""}`;
  }

  // Reference access
  function getRefDoc(){
    try { return els.refFrame.contentDocument; } catch { return null; }
  }
  function getRefWin(){
    try { return els.refFrame.contentWindow; } catch { return null; }
  }
  function getScrollEl(){
    const doc = getRefDoc();
    if(!doc) return null;
    return doc.scrollingElement || doc.documentElement || doc.body;
  }

  function canAccessRef(){
    const doc = getRefDoc();
    const win = getRefWin();
    if(!doc || !win) return false;
    // same-origin check: accessing doc.body should throw if blocked
    try { void doc.body; return true; } catch { return false; }
  }

  // Rendering
  function renderRailMarkers(){
    els.railMarkers.innerHTML = "";
    const maxY = Math.max(0, els.rail.clientHeight - 44);

    state.markers.forEach((m, idx) => {
      const b = document.createElement("div");
      b.className = "markerBtn" + (m.id === state.activeId ? " active" : "");
      b.textContent = String(idx + 1);
      b.title = `${idx+1}. ${m.title || "(Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î¯Ï„Î»Î¿)"}`;

      // map ref y -> rail y (ratio)
      const scrollEl = getScrollEl();
      const refMax = scrollEl ? Math.max(1, scrollEl.scrollHeight - scrollEl.clientHeight) : 1;
      const ratio = Math.min(1, Math.max(0, (m.y || 0) / refMax));
      const top = Math.round(6 + ratio * maxY);

      b.style.top = `${top}px`;

      b.addEventListener("click", () => {
        activateMarker(m.id, {scrollRef:true, scrollNote:true, flash:true});
      });

      els.railMarkers.appendChild(b);
    });
  }

  function renderNotes(){
    // Clear everything except emptyState placeholder
    els.notesList.querySelectorAll(".noteCard").forEach(n => n.remove());
    els.emptyState.style.display = state.markers.length ? "none" : "block";

    state.markers.forEach((m, idx) => {
      const card = document.createElement("div");
      card.className = "noteCard";
      card.dataset.id = m.id;

      const head = document.createElement("div");
      head.className = "noteHead";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = String(idx + 1);

      const title = document.createElement("div");
      title.className = "noteTitle";
      title.contentEditable = "true";
      title.spellcheck = false;
      title.textContent = m.title || `Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· ${idx+1}`;

      title.addEventListener("input", () => {
        m.title = title.textContent.trim();
        save();
        renderRailMarkers();
      });

      const miniBtns = document.createElement("div");
      miniBtns.className = "miniBtns";

      const btnGo = document.createElement("div");
      btnGo.className = "mini";
      btnGo.textContent = "â†”";
      btnGo.title = "Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î¿ Î±Î½Ï„Î¯ÏƒÏ„Î¿Î¹Ï‡Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï„Î·Ï‚ Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚";
      btnGo.addEventListener("click", () => activateMarker(m.id, {scrollRef:true, scrollNote:false, flash:true}));

      const btnDel = document.createElement("div");
      btnDel.className = "mini";
      btnDel.textContent = "ğŸ—‘";
      btnDel.title = "Î”Î¹Î±Î³ÏÎ±Ï†Î® Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… ÏƒÎ·Î¼Î±Î´Î¹Î¿Ï";
      btnDel.addEventListener("click", () => deleteMarker(m.id));

      miniBtns.append(btnGo, btnDel);

      head.append(badge, title, miniBtns);

      const body = document.createElement("div");
      body.className = "noteBody";

      const editor = document.createElement("div");
      editor.className = "editor";
      editor.contentEditable = "true";
      editor.spellcheck = false;
      editor.dataset.id = m.id;
      editor.innerHTML = state.notes[m.id] || "";

      editor.addEventListener("focus", () => {
        state.activeId = m.id;
        renderRailMarkers();
      });

      editor.addEventListener("input", () => {
        state.notes[m.id] = editor.innerHTML;
        save();
      });

      body.appendChild(editor);
      card.append(head, body);
      els.notesList.appendChild(card);
    });
  }

  function renderAll(){
    renderRailMarkers();
    renderNotes();
    updateStatuses();
  }

  function applySyncUI(){
    els.toggleSync.classList.toggle("on", state.syncOn);
  }

  // Core actions
  async function addMarker(){
    if(!canAccessRef()){
      els.refStatus.textContent = "BLOCKED: Î´ÎµÎ½ Î­Ï‡Ï‰ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ iframe (Î¬Î½Î¿Î¹Î¾Îµ Î¼Îµ server/Pages, ÏŒÏ‡Î¹ file://).";
      els.refStatus.style.color = "rgba(255,95,110,.95)";
      return;
    }

    const win = getRefWin();
    const scrollEl = getScrollEl();
    if(!win || !scrollEl) return;

    const y = Math.round(scrollEl.scrollTop || win.scrollY || 0);
    const title = prompt("Î¤Î¯Ï„Î»Î¿Ï‚ ÏƒÎ·Î¼Î±Î´Î¹Î¿Ï (Ï€.Ï‡. Â«ÎÏŒÎ¼Î¿Ï‚ Ï„Î¿Ï… HookeÂ», Â«Î•Î½Î­ÏÎ³ÎµÎ¹Î±Â»):", "") ?? "";
    const id = uid();

    state.markers.push({ id, title: title.trim(), y, createdAt: Date.now() });
    state.markers.sort((a,b)=> (a.y ?? 0) - (b.y ?? 0));
    if(!state.notes[id]) state.notes[id] = "";
    state.activeId = id;

    save();
    renderAll();
    activateMarker(id, {scrollRef:false, scrollNote:true, flash:true});
  }

  function deleteMarker(id){
    const idx = state.markers.findIndex(m => m.id === id);
    if(idx === -1) return;
    const m = state.markers[idx];
    const ok = confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏƒÎ·Î¼Î±Î´Î¹Î¿Ï${m.title ? " Â«" + m.title + "Â»" : ""}; Î˜Î± ÏƒÎ²Î·ÏƒÏ„Î¿ÏÎ½ ÎºÎ±Î¹ Î¿Î¹ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Ï„Î¿Ï….`);
    if(!ok) return;

    state.markers.splice(idx, 1);
    delete state.notes[id];

    if(state.activeId === id) state.activeId = state.markers[0]?.id ?? null;

    save();
    renderAll();
  }

  function activateMarker(id, opts={scrollRef:true, scrollNote:true, flash:false}){
    const m = state.markers.find(x => x.id === id);
    if(!m) return;
    state.activeId = id;
    renderRailMarkers();

    if(opts.scrollRef && canAccessRef()){
      const scrollEl = getScrollEl();
      if(scrollEl) scrollEl.scrollTop = m.y || 0;
    }

    if(opts.scrollNote){
      const card = els.notesList.querySelector(`.noteCard[data-id="${CSS.escape(id)}"]`);
      if(card) {
        card.scrollIntoView({behavior:"smooth", block:"start"});
        if(opts.flash){
          card.classList.remove("pulse");
          void card.offsetWidth;
          card.classList.add("pulse");
        }
      }
    }
  }

  // â€œMeaningful syncâ€: left scroll => nearest marker
  function nearestMarkerIdForY(y){
    if(!state.markers.length) return null;
    let best = state.markers[0];
    for(const m of state.markers){
      if((m.y ?? 0) <= y) best = m;
      else break;
    }
    return best?.id ?? null;
  }

  function onLeftScroll(){
    if(!state.syncOn) return;
    if(!canAccessRef()) return;

    const scrollEl = getScrollEl();
    if(!scrollEl) return;

    const y = Math.round(scrollEl.scrollTop || 0);
    const id = nearestMarkerIdForY(y);
    if(!id) return;

    if(state.activeId !== id){
      state.activeId = id;
      renderRailMarkers();
      // scroll note quietly
      const card = els.notesList.querySelector(`.noteCard[data-id="${CSS.escape(id)}"]`);
      if(card) card.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }

  function reloadRef(){
    els.refFrame.src = REF_SRC + (REF_SRC.includes("?") ? "&" : "?") + "v=" + Date.now();
  }

  function clearAll(){
    const ok = confirm("RESET: Î˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ ÎŸÎ›Î‘ Ï„Î± ÏƒÎ·Î¼Î¬Î´Î¹Î±/ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ reference. Î£Ï…Î½ÎµÏ‡Î¯Î¶Î¿Ï…Î¼Îµ;");
    if(!ok) return;
    state.markers = [];
    state.notes = {};
    state.activeId = null;
    save();
    renderAll();
  }

  // Editor toolbar
  function getActiveEditor(){
    // activeId -> find editor
    if(!state.activeId) return null;
    return els.notesList.querySelector(`.editor[data-id="${CSS.escape(state.activeId)}"]`) || null;
  }

  function exec(cmd, arg=null){
    const ed = getActiveEditor();
    if(!ed) return;

    ed.focus();
    try{
      if(cmd === "formatBlock"){
        document.execCommand(cmd, false, arg);
      }else if(arg !== null){
        document.execCommand(cmd, false, arg);
      }else{
        document.execCommand(cmd, false);
      }
    }catch(e){}
  }

  function insertLink(){
    const ed = getActiveEditor();
    if(!ed) return;
    const url = prompt("Î’Î¬Î»Îµ URL (Ï€.Ï‡. https://...):", "https://");
    if(!url) return;
    exec("createLink", url.trim());
  }

  function insertImageFromUrl(){
    const ed = getActiveEditor();
    if(!ed) return;
    const url = prompt("URL ÎµÎ¹ÎºÏŒÎ½Î±Ï‚:", "https://");
    if(!url) return;

    ed.focus();
    const img = document.createElement("img");
    img.src = url.trim();
    img.alt = "";
    insertNodeAtCursor(img);
    state.notes[state.activeId] = ed.innerHTML;
    save();
  }

  function insertNodeAtCursor(node){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount === 0){
      document.execCommand("insertHTML", false, node.outerHTML);
      return;
    }
    const range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(node);
    // move cursor after node
    range.setStartAfter(node);
    range.setEndAfter(node);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function insertImageFromFile(file){
    const ed = getActiveEditor();
    if(!ed) return;

    const reader = new FileReader();
    reader.onload = () => {
      ed.focus();
      const img = document.createElement("img");
      img.src = String(reader.result);
      img.alt = file.name || "";
      insertNodeAtCursor(img);
      state.notes[state.activeId] = ed.innerHTML;
      save();
      // NOTE: base64 images eat storage. ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï„Î¿ Î¾Î­ÏÎµÎ¹, Î±Î»Î»Î¬ ÎµÎ´Ï Ï„Î¿ ÎºÎ¬Î½Î¿Ï…Î¼Îµ Ï€ÏÎ±ÎºÏ„Î¹ÎºÎ¬.
    };
    reader.readAsDataURL(file);
  }

  // Export / Import
  function doExport(){
    const payload = {
      ref: REF_SRC,
      when: new Date().toISOString(),
      markers: state.markers,
      notes: state.notes
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `notes_${REF_SRC.replace(/[^\w]+/g,"_")}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function doImportFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      const payload = safeParse(String(reader.result), null);
      if(!payload || !Array.isArray(payload.markers) || typeof payload.notes !== "object"){
        alert("Î¤Î¿ JSON Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿ export Î±ÏÏ‡ÎµÎ¯Î¿.");
        return;
      }
      state.markers = payload.markers;
      state.notes = payload.notes || {};
      state.markers.sort((a,b)=> (a.y ?? 0) - (b.y ?? 0));
      state.activeId = state.markers[0]?.id ?? null;
      save();
      renderAll();
      alert("OK: Î­Î³Î¹Î½Îµ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®.");
    };
    reader.readAsText(file, "utf-8");
  }

  // Events
  els.btnAddMark.addEventListener("click", addMarker);
  els.btnReloadRef.addEventListener("click", reloadRef);
  els.btnClearAll.addEventListener("click", clearAll);

  els.toggleSync.addEventListener("click", () => {
    state.syncOn = !state.syncOn;
    applySyncUI();
    save();
  });

  els.toolbar.addEventListener("click", (e) => {
    const t = e.target.closest(".tool");
    if(!t || t.classList.contains("sep")) return;

    if(t.id === "btnLink"){ insertLink(); return; }
    if(t.id === "btnImgUrl"){ insertImageFromUrl(); return; }
    if(t.id === "btnImgUpload"){ els.imgFile.click(); return; }

    const cmd = t.dataset.cmd;
    const arg = t.dataset.arg;
    if(!cmd) return;
    exec(cmd, arg || null);
  });

  els.imgFile.addEventListener("change", () => {
    const f = els.imgFile.files?.[0];
    els.imgFile.value = "";
    if(!f) return;
    insertImageFromFile(f);
  });

  els.btnExport.addEventListener("click", doExport);
  els.btnImport.addEventListener("click", () => els.importFile.click());
  els.importFile.addEventListener("change", () => {
    const f = els.importFile.files?.[0];
    els.importFile.value = "";
    if(!f) return;
    doImportFile(f);
  });

  // Iframe load + scroll binding
  els.refFrame.addEventListener("load", () => {
    // status
    if(canAccessRef()){
      els.refStatus.textContent = "OK: reference Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ (same-origin).";
      els.refStatus.style.color = "rgba(159,178,217,.95)";

      const win = getRefWin();
      // bind scroll
      try{
        win.addEventListener("scroll", onLeftScroll, {passive:true});
        const scrollEl = getScrollEl();
        if(scrollEl) scrollEl.addEventListener("scroll", onLeftScroll, {passive:true});
      }catch(e){}

      // update rail mapping (new scrollHeight)
      renderRailMarkers();
    }else{
      els.refStatus.textContent = "BLOCKED: Î´ÎµÎ½ Î­Ï‡Ï‰ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ iframe (server/Pages Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹).";
      els.refStatus.style.color = "rgba(255,95,110,.95)";
      renderRailMarkers();
    }
  });

  // Init
  load();
  updateStatuses();

})();
</script>
</body>
</html>
