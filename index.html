<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reference + Notes (Î½Î¿Î·Î¼Î±Ï„Î¹ÎºÏŒ sync)</title>
  <style>
    :root{ --bg:#0b1220; --panel:#0f1b31; --line:rgba(255,255,255,.12); --txt:#eaf1ff; --muted:rgba(234,241,255,.65); }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Arial}
    .topbar{
      position:sticky;top:0;z-index:10;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;background:linear-gradient(180deg, rgba(15,27,49,.96), rgba(15,27,49,.70));
      border-bottom:1px solid var(--line); backdrop-filter: blur(8px);
    }
    .topbar .left{display:flex;gap:10px;align-items:center}
    .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    button{
      border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--txt);
      border-radius:12px; padding:8px 10px; cursor:pointer;
    }
    button:hover{background:rgba(255,255,255,.10)}
    .wrap{
      height:calc(100vh - 54px);
      display:grid;grid-template-columns: 1.1fr .9fr;
    }
    .pane{min-width:0; border-right:1px solid var(--line)}
    .pane:last-child{border-right:none}
    iframe{width:100%;height:100%;border:0;background:#fff}
    .notes{
      height:100%; overflow:auto; padding:12px;
      background:radial-gradient(800px 500px at 50% 0%, rgba(120,170,255,.10), transparent 60%);
    }
    .note{
      border:1px solid var(--line); border-radius:16px; padding:10px; margin:10px 0;
      background:rgba(255,255,255,.05);
    }
    .note.active{outline:2px solid rgba(120,170,255,.55); background:rgba(120,170,255,.10)}
    .note .meta{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .note .k{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%}
    .note textarea{
      width:100%; min-height:86px; resize:vertical;
      background:rgba(0,0,0,.25); color:var(--txt);
      border:1px solid var(--line); border-radius:12px; padding:10px; outline:none;
      font: 14px/1.4 system-ui,Segoe UI,Arial;
    }
    .note textarea:focus{border-color:rgba(120,170,255,.75)}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <div class="chip">Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬: yPhysicsALyceum1.html (local)</div>
      <div class="chip">Î”ÎµÎ¾Î¹Î¬: note Î±Î½Î¬ Ï€Î±ÏÎ¬Î³ÏÎ±Ï†Î¿/ÎµÎ½ÏŒÏ„Î·Ï„Î±</div>
    </div>
    <div class="right">
      <button id="btnExport">Export notes (JSON)</button>
      <button id="btnClear">Clear notes</button>
    </div>
  </div>

  <div class="wrap">
    <div class="pane">
      <iframe id="ref" src="yPhysicsALyceum1.html"></iframe>
    </div>

    <div class="pane">
      <div class="notes" id="notes">
        <div class="hint">Tip: ÏƒÎºÏÏŒÎ»Î±ÏÎµ Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬ â†’ ÏƒÎµ Ï€Î¬ÎµÎ¹ ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·. ÎšÎ¬Î½Îµ ÎºÎ»Î¹Îº/Focus ÏƒÎµ ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ· â†’ ÏƒÎµ Ï€Î¬ÎµÎ¹ ÏƒÏ„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ ÏƒÎ·Î¼ÎµÎ¯Î¿ Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const iframe = document.getElementById('ref');
  const notesEl = document.getElementById('notes');
  const btnExport = document.getElementById('btnExport');
  const btnClear = document.getElementById('btnClear');

  const STORAGE_KEY = 'yphysics_notes_v1';
  const notesStore = loadStore();

  let refBlocks = [];            // [{id, el, label}]
  let noteNodesById = new Map(); // id -> noteDiv
  let activeId = null;
  let programmaticScroll = false;

  function loadStore(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    catch{ return {}; }
  }
  function saveStore(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(notesStore));
  }

  function safeLabelFromEl(el){
    // Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ â€œÎ½ÏŒÎ·Î¼Î±â€ Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± ÏÎ¿Ï…Ï†Î¬Î¼Îµ ÏŒÎ»Î¿ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿
    const t = (el.innerText || el.textContent || '').replace(/\s+/g,' ').trim();
    if(!t) return el.tagName.toLowerCase();
    return t.length > 120 ? t.slice(0,120) + 'â€¦' : t;
  }

  function buildNotesUI(){
    // ÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Ï€Î±Î»Î¹Î¬ (ÎºÏÎ±Ï„Î¬ Ï„Î¿ hint)
    const hint = notesEl.querySelector('.hint');
    notesEl.innerHTML = '';
    if(hint) notesEl.appendChild(hint);

    noteNodesById.clear();

    for(const b of refBlocks){
      const wrap = document.createElement('div');
      wrap.className = 'note';
      wrap.dataset.refId = b.id;

      const meta = document.createElement('div');
      meta.className = 'meta';

      const k = document.createElement('div');
      k.className = 'k';
      k.title = b.label;
      k.textContent = b.label;

      const jumpBtn = document.createElement('button');
      jumpBtn.textContent = 'Jump';
      jumpBtn.addEventListener('click', () => scrollRefTo(b.id, true));

      meta.appendChild(k);
      meta.appendChild(jumpBtn);

      const ta = document.createElement('textarea');
      ta.placeholder = 'Î“ÏÎ¬ÏˆÎµ ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿â€¦';
      ta.value = notesStore[b.id] ?? '';

      ta.addEventListener('input', () => {
        notesStore[b.id] = ta.value;
        saveStore();
      });

      ta.addEventListener('focus', () => {
        setActive(b.id, {from:'notes'});
        scrollRefTo(b.id, false);
      });

      wrap.appendChild(meta);
      wrap.appendChild(ta);

      notesEl.appendChild(wrap);
      noteNodesById.set(b.id, wrap);
    }
  }

  function setActive(id, {from} = {}){
    if(activeId === id) return;
    activeId = id;

    // Right highlight + auto scroll
    for(const [rid, node] of noteNodesById){
      node.classList.toggle('active', rid === id);
    }
    const noteNode = noteNodesById.get(id);
    if(noteNode && from !== 'notes'){
      programmaticScroll = true;
      noteNode.scrollIntoView({block:'center', behavior:'smooth'});
      setTimeout(() => programmaticScroll = false, 250);
    }

    // Left highlight
    const doc = iframe.contentDocument;
    if(!doc) return;
    doc.querySelectorAll('[data-ref-id].ref-active').forEach(n => n.classList.remove('ref-active'));
    const el = doc.querySelector(`[data-ref-id="${CSS.escape(id)}"]`);
    if(el) el.classList.add('ref-active');
  }

  function scrollRefTo(id, smooth){
    const doc = iframe.contentDocument;
    if(!doc) return;
    const el = doc.querySelector(`[data-ref-id="${CSS.escape(id)}"]`);
    if(!el) return;

    // scroll Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ iframe
    el.scrollIntoView({block:'center', behavior: smooth ? 'smooth' : 'auto'});
    setActive(id, {from:'notes'});
  }

  function injectRefStyles(doc){
    const st = doc.createElement('style');
    st.textContent = `
      [data-ref-id]{
        scroll-margin-top: 18px;
        position: relative;
        outline: 0;
      }
      [data-ref-id].ref-active{
        box-shadow: 0 0 0 3px rgba(120,170,255,.55);
        border-radius: 10px;
      }
      /* Î¼Î¹ÎºÏÏŒ â€œÏƒÎ·Î¼Î±Î´Î¬ÎºÎ¹â€ Î³Î¹Î± Î½Î± ÎºÎ±Ï„Î±Î»Î±Î²Î±Î¯Î½ÎµÎ¹Ï‚ ÏŒÏ„Î¹ ÎµÎ¯Î½Î±Î¹ commentable */
      [data-ref-id]::after{
        content: "ğŸ“";
        position:absolute;
        right: -24px;
        top: 2px;
        opacity:.28;
        font-size: 14px;
        pointer-events:none;
      }
    `;
    doc.head.appendChild(st);
  }

  function markReferenceBlocks(doc){
    // Î”Î¹Î±Î»Î­Î³Î¿Ï…Î¼Îµ Î½Î¿Î·Î¼Î±Ï„Î¹ÎºÎ¬ blocks: Ï„Î¯Ï„Î»Î¿Î¹/Ï€Î±ÏÎ¬Î³ÏÎ±Ï†Î¿Î¹/Î»Î¯ÏƒÏ„ÎµÏ‚/quotes/pre
    const selector = 'h1,h2,h3,h4,h5,h6,p,li,blockquote,pre';
    const nodes = Array.from(doc.body.querySelectorAll(selector))
      .filter(el => {
        // ÎºÏŒÏˆÎµ â€œÎ¬Î´ÎµÎ¹ÎµÏ‚â€ Î³ÏÎ±Î¼Î¼Î­Ï‚/Î¼Î¹ÎºÏÎ¿Ï€ÏÎ¬Î³Î¼Î±Ï„Î±
        const t = (el.innerText || '').replace(/\s+/g,' ').trim();
        if(el.tagName.toLowerCase() === 'li') return t.length >= 8;
        if(el.tagName.toLowerCase() === 'p') return t.length >= 20;
        if(/^h[1-6]$/.test(el.tagName.toLowerCase())) return t.length >= 2;
        return t.length >= 10;
      });

    // Î¦Ï„Î¹Î¬Î¾Îµ ÏƒÏ„Î±Î¸ÎµÏÎ¬ ids Î¼Îµ ÏƒÎµÎ¹ÏÎ¬. Î”ÎµÎ½ Ï€ÎµÎ¹ÏÎ¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿, Î¼ÏŒÎ½Î¿ runtime.
    refBlocks = nodes.map((el, i) => {
      const id = `ref_${String(i+1).padStart(4,'0')}`;
      el.setAttribute('data-ref-id', id);
      return { id, el, label: safeLabelFromEl(el) };
    });
  }

  function setupSemanticSync(doc){
    // IntersectionObserver: Ï€Î¿Î¹Î¿ block ÎµÎ¯Î½Î±Î¹ â€œÏƒÏ„Î¿ ÎºÎ­Î½Ï„ÏÎ¿â€ Ï„Î·Ï‚ Î¿Î¸ÏŒÎ½Î·Ï‚ Ï„Î¿Ï… iframe
    const root = doc.scrollingElement || doc.documentElement;

    const obs = new IntersectionObserver((entries) => {
      if(programmaticScroll) return;

      // Î´Î¹Î¬Î»ÎµÎ¾Îµ Î±Ï…Ï„ÏŒ Î¼Îµ Ï„Î¿ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ intersectionRatio
      let best = null;
      for(const e of entries){
        if(!e.isIntersecting) continue;
        if(!best || e.intersectionRatio > best.intersectionRatio) best = e;
      }
      if(!best) return;

      const id = best.target.getAttribute('data-ref-id');
      if(id) setActive(id, {from:'ref'});
    }, {
      root: null, // viewport Ï„Î¿Ï… iframe doc
      threshold: [0.10, 0.20, 0.35, 0.50, 0.70]
    });

    for(const b of refBlocks) obs.observe(b.el);

    // ÎšÎ»Î¹Îº ÏƒÎµ block: Ï€Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î¿ Î±Î½Ï„Î¯ÏƒÏ„Î¿Î¹Ï‡Î¿ note (Î³ÏÎ®Î³Î¿ÏÎ¿ â€œÏƒÏ‡Î¿Î»Î¹Î¬Î¶Ï‰ ÎµÎ´Ïâ€)
    doc.body.addEventListener('click', (ev) => {
      const el = ev.target.closest('[data-ref-id]');
      if(!el) return;
      const id = el.getAttribute('data-ref-id');
      if(!id) return;
      setActive(id, {from:'ref'});
      const noteNode = noteNodesById.get(id);
      if(noteNode){
        noteNode.scrollIntoView({block:'center', behavior:'smooth'});
        const ta = noteNode.querySelector('textarea');
        if(ta) ta.focus({preventScroll:true});
      }
    }, true);
  }

  btnExport.addEventListener('click', () => {
    const data = JSON.stringify(notesStore, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'notes.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 500);
  });

  btnClear.addEventListener('click', () => {
    localStorage.removeItem(STORAGE_KEY);
    for(const k of Object.keys(notesStore)) delete notesStore[k];
    // ÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Ï„Î± textareas
    document.querySelectorAll('.note textarea').forEach(t => t.value = '');
  });

  iframe.addEventListener('load', () => {
    const doc = iframe.contentDocument;
    if(!doc){ alert('Î”ÎµÎ½ Î¼Ï€Î¿ÏÏ Î½Î± Î´Î¹Î±Î²Î¬ÏƒÏ‰ Ï„Î¿ iframe. Î’ÎµÎ²Î±Î¹ÏÏƒÎ¿Ï… ÏŒÏ„Î¹ Î· yPhysicsALyceum1.html ÎµÎ¯Î½Î±Î¹ local ÏƒÏ„Î¿ Î¯Î´Î¹Î¿ repo/Ï†Î¬ÎºÎµÎ»Î¿.'); return; }

    injectRefStyles(doc);
    markReferenceBlocks(doc);
    buildNotesUI();
    setupSemanticSync(doc);

    // ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Î±ÏÏ‡Î¹ÎºÎ¬ Ï„Î¿ Ï€ÏÏÏ„Î¿ block
    if(refBlocks[0]) setActive(refBlocks[0].id, {from:'ref'});
  });
})();
</script>
</body>
</html>
